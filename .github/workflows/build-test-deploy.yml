name: Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '*'

env:
  AWS_REGION: 'eu-west-2'
  CYPRESS_CACHE_FOLDER: cypress/cache

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for the actions/checkout

jobs:
  ###############################################################################
  # Install dependencies & build packages
  ###############################################################################

  install:
    name: Install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/install-cache
      - name: Install
        run: npm ci --no-audit --no-fund --legacy-peer-deps

  build:
    name: Build
    needs: [install]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/install-cache
      - uses: ./.github/actions/build-cache
      - name: Start mock server
        run: npm run dev:mock-server &
      - name: Wait for Mock Server
        shell: sh
        run: ./.github/scripts/wait-for-service.sh http://localhost:3005
      - name: Build
        run: |
          touch .env.local
          echo API_URL=http://localhost:3005 >> .env.local
          NODE_ENV=test npm run build

  ###############################################################################
  # Code quality checks
  ###############################################################################

  quality-checks:
    name: Lint
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/install-cache
      - uses: ./.github/actions/build-cache
      - name: Quality check
        run: npm run lint

  ##############################################################################
  # Unit tests
  ##############################################################################

  unit-tests:
    name: Unit tests
    permissions: write-all
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/install-cache
      - uses: ./.github/actions/build-cache
      - name: Unit tests
        run: npm run test:ci
      - name: Unit tests coverage comment
        uses: ukhsa-internal/jest-coverage-comment-action@v1
        with:
          coverage-summary-path: ./coverage/coverage-summary.json
          junitxml-path: ./junit.xml
          title: Unit tests coverage

  ##############################################################################
  # Cypress tests
  ##############################################################################

  cypress-tests:
    name: Cypress tests
    needs: [build]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # https://github.com/cypress-io/github-action/issues/48
      matrix:
        containers: [1, 2] # Uses 2 parallel instances
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/install-cache
      - uses: ./.github/actions/build-cache
      - name: Start mock server
        run: npm run dev:mock-server &
      - name: Wait for Mock Server
        shell: sh
        run: ./.github/scripts/wait-for-service.sh http://localhost:3005
      - name: Re-build
        run: |
          NODE_ENV=test npm run build
      - name: Start app
        run: NODE_ENV=test npm run start &
      - uses: ./.github/actions/run-cypress-tests
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          record-key: ${{ secrets.CYPRESS_RECORD_KEY }}
          cache-folder: cypress/cache

  cypress-tests-success:
    name: Cypress tests check
    needs: [cypress-tests]
    runs-on: ubuntu-latest
    steps:
      - run: echo 'All Cypress tests passed âœ…'

  ###############################################################################
  # Deploy
  ###############################################################################

  deploy:
    name: ECR Image Push
    needs: [quality-checks, unit-tests, cypress-tests-success]
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' }}

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::518944279943:role/devops_github_actions_wp_frontend
          role-session-name: testsession
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: wp-frontend
          IMAGE_TAG: latest
        run: |
          docker build --build-arg API_URL=${{ vars.API_URL }} --build-arg API_KEY=${{ secrets.API_KEY }} -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG . 
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          aws ecs update-service --cluster wp-frontend-cluster --service wp-frontend-service --force-new-deployment --region eu-west-2
